<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - BUCOHub</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* ============================= */
    /*        BASE STYLES            */
    /* ============================= */
    body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #4a2c5a 0%, #3d1a4f 100%); 
        color: #fff;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
    }
    
    .container {
        max-width: 1400px;
        margin: auto;
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        width: 100%;
    }

    /* ============================= */
    /*        HEADER STYLES          */
    /* ============================= */
    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        position: relative;
    }

    .logo { 
        color: #ffd700; 
        font-size: 30px; 
        font-weight: bold; 
        display: flex; 
        justify-content: center;
        align-items: center;
        gap: 10px; 
    }
    
    .gear { 
        width: 20px;
        height: 20px;
        border: 3px solid #f5f5f5; 
        border-radius: 50%; 
        position: relative;
    }

    .gear::before { 
        content: ''; 
        position: absolute; 
        top: 50%; 
        left: 50%; 
        transform: translate(-50%, -50%);
        width: 8px; 
        height: 8px;
        background: #f5f5f5; 
        border-radius: 50%; 
    }

    /* ============================= */
    /*        NAVIGATION STYLES      */
    /* ============================= */
    .three-line-btn {
        width: 40px;
        height: 40px;
        background: #2d1b3d;
        border: 2px solid #ffd700;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 4px;
        z-index: 1001;
        transition: all 0.3s ease;
    }

    .three-line-btn:hover {
        background: #3d1a4f;
    }

    .three-line-btn .line {
        width: 20px;
        height: 2px;
        background: #ffd700;
        transition: all 0.3s ease;
    }

    .three-line-btn.active .line:nth-child(1) {
        transform: translateY(6px) rotate(45deg);
    }

    .three-line-btn.active .line:nth-child(2) {
        opacity: 0;
    }

    .three-line-btn.active .line:nth-child(3) {
        transform: translateY(-6px) rotate(-45deg);
    }

    .side-panel {
        position: absolute;
        top: 100%;
        right: 0;
        width: 300px;
        background: linear-gradient(135deg, #4a2c5a 0%, #3d1a4f 100%);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        transition: all 0.3s ease;
        padding: 20px;
        display: flex;
        flex-direction: column;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
    }

    .side-panel.active {
        max-height: 500px;
        opacity: 1;
    }

    .side-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .side-panel-title {
        color: #ffd700;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .side-panel-close {
        background: none;
        border: none;
        color: #b8a3c7;
        font-size: 24px;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .side-panel-close:hover {
        color: #ffd700;
    }

    .side-panel-content {
        flex: 1;
        overflow-y: auto;
    }

    .side-panel-option {
        display: block;
        width: 100%;
        padding: 12px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 5px;
        color: white;
        text-align: left;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .side-panel-option:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
    }

    .side-panel-option i {
        margin-right: 10px;
        color: #ffd700;
        width: 20px;
        text-align: center;
    }

    .logout-btn {
        display: block;
        width: 100%;
        padding: 12px;
        margin-top: 15px;
        background: rgba(239, 68, 68, 0.3);
        border: none;
        border-radius: 5px;
        color: white;
        text-align: left;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .logout-btn:hover {
        background: rgba(239, 68, 68, 0.5);
        transform: translateX(5px);
    }

    .logout-btn i {
        margin-right: 10px;
        color: #ffd700;
        width: 20px;
        text-align: center;
    }

    /* ============================= */
    /*        FORM STYLES            */
    /* ============================= */
    input, button, select {
        padding: 10px;
        margin: 5px;
        border-radius: 5px;
        border: none;
        font-family: inherit;
    }
    
    button {
        background: #2563eb;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
    }
    
    button:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
    }
    
    button:disabled {
        background: #6b7280;
        cursor: not-allowed;
        transform: none;
    }
    
    #logoutBtn {
        background: #ef4444;
    }
    
    #logoutBtn:hover {
        background: #dc2626;
    }

    /* ============================= */
    /*        TABLE STYLES           */
    /* ============================= */
    table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background: rgba(0, 0, 0, 0.3);
    }
    
    th, td {
        border: 1px solid #4b5563;
        padding: 12px;
        text-align: left;
    }
    
    th {
        cursor: pointer;
        background: rgba(0, 0, 0, 0.2);
        transition: background 0.3s ease;
        position: relative;
    }
    
    th:hover {
        background: rgba(0, 0, 0, 0.3);
    }
    
    th::after {
        content: 'â†•';
        position: absolute;
        right: 10px;
        opacity: 0.5;
        font-size: 12px;
    }

    /* ============================= */
    /*        LAYOUT STYLES          */
    /* ============================= */
    .hidden { 
        display: none; 
    }
    
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .search-container {
        display: flex;
        margin-bottom: 15px;
        gap: 10px;
        flex: 1;
        min-width: 300px;
    }
    
    .search-container input {
        flex: 1;
        min-width: 200px;
    }
    
    .controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .sort-container {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 25px;
        gap: 15px;
    }
    
    .pagination-info {
        margin: 0 15px;
        font-size: 14px;
        color: #d1d5db;
    }
    
    .login-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .login-form input {
        width: 100%;
        box-sizing: border-box;
        padding: 12px;
    }
    
    .login-form button {
        width: 100%;
        padding: 12px;
    }
    
    #loginMessage {
        min-height: 20px;
        margin-top: 10px;
        text-align: center;
        font-size: 14px;
    }

    /* ============================= */
    /*        COURSES STYLES         */
    /* ============================= */
    .courses-list {
        max-width: 200px;
        font-size: 12px;
        line-height: 1.4;
    }
    
    .course-tag {
        display: inline-block;
        background: rgba(59, 130, 246, 0.3);
        padding: 3px 8px;
        margin: 2px;
        border-radius: 4px;
        font-size: 11px;
        border: 1px solid rgba(59, 130, 246, 0.5);
    }

    /* ============================= */
    /*        PROFILE PICTURE STYLES */
    /* ============================= */
    .profile-picture {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #ffd700;
        transition: transform 0.3s ease;
    }
    
    .profile-picture:hover {
        transform: scale(1.1);
    }
    
    .profile-picture-large {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #ffd700;
        margin: 0 auto;
        display: block;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .no-image {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #4b5563;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 10px;
        border: 2px solid #6b7280;
        font-weight: bold;
    }
    
    .no-image-large {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        background: #4b5563;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 14px;
        margin: 0 auto;
        border: 4px solid #ffd700;
        font-weight: bold;
    }
    
    .name-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .clickable-name {
        color: #60a5fa;
        cursor: pointer;
        text-decoration: underline;
        transition: color 0.2s ease;
        font-weight: 500;
    }
    
    .clickable-name:hover {
        color: #93c5fd;
    }

    /* ============================= */
    /*        ACTION BUTTONS         */
    /* ============================= */
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .action-btn {
        padding: 6px 10px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .edit-btn {
        background: #10b981;
        color: white;
    }
    
    .edit-btn:hover {
        background: #059669;
    }
    
    .view-btn {
        background: #3b82f6;
        color: white;
    }
    
    .view-btn:hover {
        background: #2563eb;
    }
    
    .delete-btn {
        background: #ef4444;
        color: white;
    }
    
    .delete-btn:hover {
        background: #dc2626;
    }

    /* ============================= */
    /*        EXPORT STYLES          */
    /* ============================= */
    .export-container {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
    }
    
    .export-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 15px;
        border-radius: 5px;
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* ============================= */
    /*        MODAL STYLES           */
    /* ============================= */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .modal-overlay.show {
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 1;
    }
    
    .modal-content {
        background: linear-gradient(135deg, #4a2c5a 0%, #3d1a4f 100%);
        border-radius: 12px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        transform: scale(0.8);
        transition: transform 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .modal-overlay.show .modal-content {
        transform: scale(1);
    }
    
    .modal-header {
        background: #2d1b3d;
        padding: 25px;
        border-radius: 12px 12px 0 0;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #ffd700;
    }
    
    .modal-title {
        color: #ffd700;
        font-size: 26px;
        font-weight: bold;
    }
    
    .close-btn {
        background: none;
        border: none;
        color: #b8a3c7;
        font-size: 28px;
        cursor: pointer;
        padding: 5px;
        transition: color 0.3s ease;
    }
    
    .close-btn:hover {
        color: #ffd700;
    }
    
    .modal-body {
        padding: 30px;
    }
    
    .student-details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .detail-group {
        margin-bottom: 18px;
    }
    
    .detail-label {
        color: #ffd700;
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 8px;
        display: block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .detail-value {
        color: #fff;
        font-size: 16px;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        border: 1px solid #4b5563;
        min-height: 44px;
        display: flex;
        align-items: center;
    }
    
    .progress-section {
        margin-top: 30px;
        padding-top: 25px;
        border-top: 2px solid #4b5563;
    }
    
    .progress-title {
        color: #ffd700;
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .progress-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid #4b5563;
    }
    
    .progress-course {
        color: #fff;
        font-weight: 500;
        flex: 1;
    }
    
    .progress-bar-container {
        width: 200px;
        height: 10px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        overflow: hidden;
        margin: 0 15px;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #34d399);
        border-radius: 5px;
        transition: width 0.5s ease;
    }
    
    .progress-percent {
        color: #ffd700;
        font-size: 14px;
        font-weight: bold;
        min-width: 45px;
        text-align: right;
    }

    /* ============================= */
    /*        EDIT FORM STYLES       */
    /* ============================= */
    .edit-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        color: #ffd700;
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 8px;
        display: block;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .form-input {
        width: 100%;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #4b5563;
        border-radius: 6px;
        color: white;
        font-size: 16px;
        box-sizing: border-box;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #ffd700;
    }
    
    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }
    
    .form-select {
        width: 100%;
        padding: 10px 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid #4b5563;
        border-radius: 6px;
        color: white;
        font-size: 16px;
        box-sizing: border-box;
    }
    
    .form-select option {
        background: #3d1a4f;
        color: white;
    }
    
    .form-actions {
        grid-column: 1 / -1;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #4b5563;
    }
    
    .save-btn {
        background: #10b981;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s ease;
    }
    
    .save-btn:hover {
        background: #059669;
    }
    
    .cancel-btn {
        background: #6b7280;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s ease;
    }
    
    .cancel-btn:hover {
        background: #4b5563;
    }
    
    .full-width {
        grid-column: 1 / -1;
    }

    /* ============================= */
    /*        RESPONSIVE STYLES      */
    /* ============================= */
    @media (max-width: 1024px) {
        .container {
            padding: 15px;
        }
        
        .student-details-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .controls-container {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-container {
            min-width: auto;
        }
        
        .edit-form {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        body {
            padding: 10px;
        }
        
        .modal-content {
            width: 95%;
            margin: 10px;
        }
        
        .name-container {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .top-bar {
            flex-direction: column;
            align-items: stretch;
            text-align: center;
        }
        
        .progress-item {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }
        
        .progress-bar-container {
            width: 100%;
            margin: 5px 0;
        }
        
        table {
            font-size: 14px;
        }
        
        th, td {
            padding: 8px;
        }
        
        .side-panel {
            width: 100%;
            right: 0;
            left: 0;
        }
        
        .action-buttons {
            flex-direction: column;
        }
    }

    @media (max-width: 480px) {
        .logo {
            font-size: 24px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .profile-picture-large {
            width: 100px;
            height: 100px;
        }
        
        .no-image-large {
            width: 100px;
            height: 100px;
        }
        
        .export-container {
            flex-direction: column;
        }
        
        .export-btn {
            justify-content: center;
        }
        
        .form-actions {
            flex-direction: column;
        }
    }
</style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">BUC<div class="gear"></div>Del<div style="margin: 0; color: #816f07;">Admin Portal</div></div>

        <!-- Three-line button -->
        <button class="three-line-btn" id="threeLineBtn" title="Toggle Menu">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
        </button>

        <!-- Side panel -->
        <div class="side-panel" id="sidePanel">
            <div class="side-panel-header">
                <div class="side-panel-title">Admin Menu</div>
                <button class="side-panel-close" id="sidePanelClose">&times;</button>
            </div>
            <div class="side-panel-content">
                <button class="side-panel-option" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> Home
                </button>
                <button class="side-panel-option" onclick="window.location.href='index.html'">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="side-panel-option" onclick="window.location.href='student-profile.html'">
                    <i class="fas fa-user-graduate"></i> Students
                </button>
                <button class="side-panel-option" onclick="window.location.href='courses.html'">
                    <i class="fas fa-book"></i> Courses
                </button>
                <button class="side-panel-option" onclick="window.location.href='reports.html'">
                    <i class="fas fa-chart-bar"></i> Reports
                </button>
                <button class="side-panel-option" onclick="window.location.href='settings.html'">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>
    
    <!-- LOGIN FORM -->
    <div id="loginSection">
        <h3 style="text-align: center; color: #ffd700; margin-bottom: 20px;">Admin Login</h3>
        <div class="login-form">
            <input type="email" id="email" placeholder="Email" value="admin@bucohub.com">
            <input type="password" id="password" placeholder="Password" value="admin123">
            <button onclick="login()" id="loginBtn">Login</button>
            <p id="loginMessage"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
        <div class="top-bar">
            <h3 style="margin: 0; color: #ffd700;">Registered Students</h3>
        </div>
    
        <!-- Search and Controls -->
        <div class="controls-container">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Search by name or email...">
                <button onclick="searchStudents()">Search</button>
                <button onclick="clearSearch()">Clear</button>
            </div>
            
            <div class="export-container">
                <button onclick="exportToCSV()" class="export-btn" style="background: #10b981;">
                    <i class="fas fa-file-csv"></i> Export to CSV
                </button>
                <button onclick="exportToPDF()" class="export-btn" style="background: #ef4444;">
                    <i class="fas fa-file-pdf"></i> Export to PDF
                </button>
            </div>

            <div class="sort-container">
                <label style="color: #ffd700;">Sort by:</label>
                <select id="sortField">
                    <option value="firstName">Name</option>
                    <option value="email">Email</option>
                    <option value="age">Age</option>
                    <option value="id">ID</option>
                    <option value="created_at">Registration Date</option>
                </select>
                <select id="sortOrder">
                    <option value="ASC">Ascending</option>
                    <option value="DESC">Descending</option>
                </select>
                <button onclick="applySorting()">Apply</button>
            </div>
        </div>
    
        <table id="studentsTable">
            <thead>
            <tr>
                <th onclick="sortByColumn('id')">ID</th>
                <th onclick="sortByColumn('firstName')">Name</th>
                <th onclick="sortByColumn('email')">Email</th>
                <th>Phone</th>
                <th onclick="sortByColumn('age')">Age</th>
                <th>Courses</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination-container">
            <button id="prevBtn" onclick="previousPage()" disabled>Previous</button>
            <span class="pagination-info" id="pageInfo">Page 1 of 1</span>
            <button id="nextBtn" onclick="nextPage()" disabled>Next</button>
        </div>
    </div>
</div>

<!-- Student Details Modal -->
<div class="modal-overlay" id="studentDetailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Student Details</div>
            <button class="close-btn" onclick="closeStudentDetails()">&times;</button>
        </div>
        <div class="modal-body" id="studentDetailsBody">
            <!-- Student details will be populated here -->
        </div>
    </div>
</div>

<!-- Edit Student Modal -->
<div class="modal-overlay" id="editStudentModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Edit Student</div>
            <button class="close-btn" onclick="closeEditStudent()">&times;</button>
        </div>
        <div class="modal-body" id="editStudentBody">
            <!-- Edit form will be populated here -->
        </div>
    </div>
</div>

<script>
    // =============================
    // CONFIGURATION & STATE
    // =============================
    //const API_URL = "http://localhost:3000/api";
    //const SERVER_URL = "http://localhost:3000";
    // NEW:
    const API_URL = `${window.location.origin}/api`;
    const SERVER_URL = window.location.origin;
    
    let currentState = {
        page: 1,
        limit: 10,
        search: '',
        sort: 'id',
        order: 'ASC',
        totalPages: 1,
        totalStudents: 0
    };

    let currentEditingStudent = null;

    // =============================
    // NAVIGATION FUNCTIONALITY
    // =============================
    const threeLineBtn = document.getElementById('threeLineBtn');
    const sidePanel = document.getElementById('sidePanel');
    const sidePanelClose = document.getElementById('sidePanelClose');

    function toggleSidePanel() {
        threeLineBtn.classList.toggle('active');
        sidePanel.classList.toggle('active');
    }

    function closeSidePanelOnClickOutside(event) {
        const isClickInsideSidePanel = sidePanel.contains(event.target);
        const isClickOnMenuButton = threeLineBtn.contains(event.target);
        
        if (!isClickInsideSidePanel && !isClickOnMenuButton && sidePanel.classList.contains('active')) {
            toggleSidePanel();
        }
    }

    // =============================
    // INITIALIZATION
    // =============================
    document.addEventListener('DOMContentLoaded', function() {
        initializeEventListeners();
        
        // Check if user is already logged in
        if (localStorage.getItem("adminLoggedIn") === "true") {
            showDashboard();
        }
    });

    function initializeEventListeners() {
        // Navigation
        threeLineBtn.addEventListener('click', toggleSidePanel);
        sidePanelClose.addEventListener('click', toggleSidePanel);
        document.addEventListener('click', closeSidePanelOnClickOutside);
        
        // Enter key support for login
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const searchInput = document.getElementById('searchInput');

        if (emailInput && passwordInput) {
            emailInput.addEventListener('keypress', (e) => e.key === 'Enter' && login());
            passwordInput.addEventListener('keypress', (e) => e.key === 'Enter' && login());
        }

        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => e.key === 'Enter' && searchStudents());
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeStudentDetails();
                closeEditStudent();
            }
        });
    }

    // =============================
    // AUTHENTICATION
    // =============================
    async function login() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const msg = document.getElementById('loginMessage');
        const loginBtn = document.getElementById('loginBtn');

        if (!email || !password) {
            showMessage(msg, "Please enter both email and password!", "error");
            return;
        }

        setButtonState(loginBtn, true, "Logging in...");
        showMessage(msg, "", "info");

        try {
            const res = await fetch(`${API_URL}/admins/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                showMessage(msg, "Login successful!", "success");
                localStorage.setItem("adminLoggedIn", "true");
                localStorage.setItem("adminToken", data.token || "dummy-token");
                localStorage.setItem("adminData", JSON.stringify(data.admin || {}));
                setTimeout(() => showDashboard(), 1000);
            } else {
                showMessage(msg, data.error || data.message || "Invalid credentials!", "error");
            }
        } catch (error) {
            console.error("Login error:", error);
            showMessage(msg, "Login failed. Check if server is running on http://localhost:3000", "error");
        } finally {
            setButtonState(loginBtn, false, "Login");
        }
    }

    function logout() {
        localStorage.removeItem("adminLoggedIn");
        localStorage.removeItem("adminToken");
        localStorage.removeItem("adminData");
        document.getElementById('dashboard').classList.add('hidden');
        document.getElementById('loginSection').classList.remove('hidden');
        showMessage(document.getElementById('loginMessage'), "You've been logged out.", "success");
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
    }

    function showDashboard() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        fetchStudents();
    }

    // =============================
    // STUDENT MANAGEMENT - FIXED ENDPOINTS
    // =============================
    async function fetchStudents() {
        try {
            const { page, limit, search, sort, order } = currentState;
            let url = `${API_URL}/students?page=${page}&limit=${limit}&sort=${sort}&order=${order}`;
            
            if (search) {
                url += `&search=${encodeURIComponent(search)}`;
            }
            
            console.log('Fetching students from:', url);
            
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`Failed to fetch students: ${res.status}`);
            }
            
            const response = await res.json();
            console.log('Students response:', response);
            
            if (response.students) {
                displayStudents(response.students);
                updatePagination(response);
            } else {
                throw new Error('Invalid response format from server');
            }
            
        } catch (error) {
            console.error("Error fetching students:", error);
            showTableError(`Error loading students: ${error.message}`);
        }
    }

    function displayStudents(students) {
        const tbody = document.querySelector("#studentsTable tbody");
        
        if (!students || students.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: #ffd700;">No students found matching your criteria</td></tr>`;
            return;
        }

        tbody.innerHTML = students.map(student => `
            <tr>
                <td>${student.id}</td>
                <td>
                    <div class="name-container">
                        ${getProfilePictureHTML(student.profilePictureUrl)}
                        <span class="clickable-name" onclick="viewStudentDetails(${student.id})">
                            ${student.firstName} ${student.lastName}
                        </span>
                    </div>
                </td>
                <td>${student.email}</td>
                <td>${student.phone || 'N/A'}</td>
                <td>${student.age || 'N/A'}</td>
                <td class="courses-list">${formatCourses(student.courses)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editStudent(${student.id})" title="Edit Student">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn view-btn" onclick="viewStudentDetails(${student.id})" title="View Details">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteStudent(${student.id})" title="Delete Student">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function getProfilePictureURL(profilePictureUrl) {
        if (!profilePictureUrl) return null;
        
        // If it's already a full URL, return as is
        if (profilePictureUrl.startsWith('http')) {
            return profilePictureUrl;
        }
        
        // If it starts with /uploads, prepend server URL
        if (profilePictureUrl.startsWith('/uploads/')) {
            return `${SERVER_URL}${profilePictureUrl}`;
        }
        
        // If it's just a filename, construct the full URL
        return `${SERVER_URL}/uploads/${profilePictureUrl}`;
    }

    function getProfilePictureHTML(profilePictureUrl) {
        const fullUrl = getProfilePictureURL(profilePictureUrl);
        
        if (fullUrl) {
            return `<img src="${fullUrl}" alt="Profile" class="profile-picture" 
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
        }
        
        return `<div class="no-image">No Image</div>`;
    }

    // =============================
    // STUDENT DETAILS MODAL
    // =============================
    async function viewStudentDetails(studentId) {
        try {
            console.log('Fetching student details for ID:', studentId);
            const res = await fetch(`${API_URL}/students/${studentId}`);
            
            if (!res.ok) {
                throw new Error(`Failed to fetch student details: ${res.status}`);
            }
            
            const student = await res.json();
            displayStudentDetails(student);
        } catch (error) {
            console.error("Error fetching student details:", error);
            alert("Failed to load student details: " + error.message);
        }
    }

    function displayStudentDetails(student) {
        const modalBody = document.getElementById('studentDetailsBody');
        const profilePictureUrl = getProfilePictureURL(student.profilePictureUrl);
        
        modalBody.innerHTML = `
            <div style="text-align: center; margin-bottom: 25px;">
                ${profilePictureUrl ? 
                    `<img src="${profilePictureUrl}" alt="Profile" class="profile-picture-large" 
                        onerror="this.style.display='none'; document.getElementById('noImageFallback').style.display='flex';">` 
                    : ''
                }
                <div id="noImageFallback" class="no-image-large" style="${profilePictureUrl ? 'display: none;' : ''}">
                    No Image
                </div>
            </div>
            
            <div class="student-details-grid">
                <div class="detail-group">
                    <span class="detail-label">Student ID</span>
                    <div class="detail-value">${student.id}</div>
                </div>
                <div class="detail-group">
                    <span class="detail-label">Full Name</span>
                    <div class="detail-value">${student.firstName} ${student.lastName}</div>
                </div>
                <div class="detail-group">
                    <span class="detail-label">Email</span>
                    <div class="detail-value">${student.email}</div>
                </div>
                <div class="detail-group">
                    <span class="detail-label">Phone</span>
                    <div class="detail-value">${student.phone || 'N/A'}</div>
                </div>
                <div class="detail-group">
                    <span class="detail-label">Age</span>
                    <div class="detail-value">${student.age || 'N/A'}</div>
                </div>
                <div class="detail-group">
                    <span class="detail-label">Education</span>
                    <div class="detail-value">${student.education || 'N/A'}</div>
                </div>
                <div class="detail-group">
                    <span class="detail-label">Experience</span>
                    <div class="detail-value">${student.experience || 'N/A'}</div>
                </div>
                <div class="detail-group">
                    <span class="detail-label">Motivation</span>
                    <div class="detail-value">${student.motivation || 'N/A'}</div>
                </div>
            </div>
            
            ${student.courses && student.courses.length > 0 ? `
                <div class="progress-section">
                    <div class="progress-title">Course Progress</div>
                    ${generateProgressData(student.courses).map(course => `
                        <div class="progress-item">
                            <span class="progress-course">${course.name}</span>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${course.progress}%"></div>
                            </div>
                            <span class="progress-percent">${course.progress}%</span>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #4b5563;">
                <div class="detail-label">Registration Date</div>
                <div class="detail-value">${student.created_at ? new Date(student.created_at).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'N/A'}</div>
            </div>
        `;
        
        document.getElementById('studentDetailsModal').classList.add('show');
    }

    function closeStudentDetails() {
        document.getElementById('studentDetailsModal').classList.remove('show');
    }

    // =============================
    // EDIT STUDENT FUNCTIONALITY - FIXED
    // =============================
    async function editStudent(studentId) {
        try {
            console.log('Fetching student for editing ID:', studentId);
            const res = await fetch(`${API_URL}/students/${studentId}`);
            
            if (!res.ok) {
                throw new Error(`Failed to fetch student details: ${res.status}`);
            }
            
            const student = await res.json();
            displayEditForm(student);
        } catch (error) {
            console.error("Error fetching student for editing:", error);
            alert("Failed to load student for editing: " + error.message);
        }
    }

    function displayEditForm(student) {
        currentEditingStudent = student;
        const modalBody = document.getElementById('editStudentBody');
        const profilePictureUrl = getProfilePictureURL(student.profilePictureUrl);
        
        // Helper function to check if course is selected
        const isCourseSelected = (courseName) => {
            if (!student.courses) return false;
            
            if (Array.isArray(student.courses)) {
                return student.courses.includes(courseName);
            }
            
            if (typeof student.courses === 'string') {
                try {
                    const parsed = JSON.parse(student.courses);
                    if (Array.isArray(parsed)) {
                        return parsed.includes(courseName);
                    }
                } catch {
                    return student.courses === courseName;
                }
            }
            
            return false;
        };
        
        modalBody.innerHTML = `
            <div style="text-align: center; margin-bottom: 25px;">
                ${profilePictureUrl ? 
                    `<img src="${profilePictureUrl}" alt="Profile" class="profile-picture-large" 
                          onerror="this.style.display='none'; document.getElementById('noImageFallback').style.display='flex';">` 
                    : ''
                }
                <div id="noImageFallback" class="no-image-large" style="${profilePictureUrl ? 'display: none;' : ''}">
                    No Image
                </div>
            </div>
            
            <form id="editStudentForm" class="edit-form">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" name="firstName" value="${student.firstName || ''}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" name="lastName" value="${student.lastName || ''}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" name="email" value="${student.email || ''}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="text" class="form-input" name="phone" value="${student.phone || ''}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Age</label>
                    <input type="number" class="form-input" name="age" value="${student.age || ''}" min="16" max="100">
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Courses</label>
                    <select class="form-select" name="courses" multiple style="height: 120px;">
                        <option value="Web Development" ${isCourseSelected('Web Development') ? 'selected' : ''}>Web Development</option>
                        <option value="Data Science" ${isCourseSelected('Data Science') ? 'selected' : ''}>Data Science</option>
                        <option value="Mobile App Development" ${isCourseSelected('Mobile App Development') ? 'selected' : ''}>Mobile App Development</option>
                        <option value="UI/UX Design" ${isCourseSelected('UI/UX Design') ? 'selected' : ''}>UI/UX Design</option>
                        <option value="Digital Marketing" ${isCourseSelected('Digital Marketing') ? 'selected' : ''}>Digital Marketing</option>
                        <option value="Cybersecurity" ${isCourseSelected('Cybersecurity') ? 'selected' : ''}>Cybersecurity</option>
                    </select>
                    <small style="color: #b8a3c7; font-size: 12px;">Hold Ctrl/Cmd to select multiple courses</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Education</label>
                    <input type="text" class="form-input" name="education" value="${student.education || ''}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Experience</label>
                    <input type="text" class="form-input" name="experience" value="${student.experience || ''}">
                </div>
                
                <div class="form-group full-width">
                    <label class="form-label">Motivation</label>
                    <textarea class="form-input form-textarea" name="motivation">${student.motivation || ''}</textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeEditStudent()">Cancel</button>
                    <button type="submit" class="save-btn">Save Changes</button>
                </div>
            </form>
        `;
        
        // Add form submit handler
        document.getElementById('editStudentForm').addEventListener('submit', handleEditSubmit);
        
        document.getElementById('editStudentModal').classList.add('show');
    }

    async function handleEditSubmit(event) {
        event.preventDefault();
        
        if (!currentEditingStudent) return;
        
        const form = event.target;
        const formData = new FormData(form);
        
        // Get selected courses
        const selectedCourses = [];
        const courseOptions = form.courses.options;
        for (let i = 0; i < courseOptions.length; i++) {
            if (courseOptions[i].selected) {
                selectedCourses.push(courseOptions[i].value);
            }
        }
        
        // Prepare update data
        const updatedData = {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone') || null,
            age: formData.get('age') ? parseInt(formData.get('age')) : null,
            education: formData.get('education') || null,
            experience: formData.get('experience') || null,
            motivation: formData.get('motivation') || null,
            courses: selectedCourses
        };
        
        console.log('Updating student with data:', updatedData);
        
        try {
            const res = await fetch(`${API_URL}/students/${currentEditingStudent.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedData)
            });
            
            const responseText = await res.text();
            console.log('Raw response:', responseText);
            
            let result;
            try {
                result = JSON.parse(responseText);
            } catch (e) {
                console.error('Failed to parse response as JSON:', e);
                throw new Error('Invalid response from server');
            }
            
            if (!res.ok) {
                throw new Error(result.error || result.message || `HTTP ${res.status}: Failed to update student`);
            }
            
            if (result.success) {
                alert("Student updated successfully!");
                closeEditStudent();
                fetchStudents(); // Refresh the table
            } else {
                throw new Error(result.error || result.message || 'Failed to update student');
            }
        } catch (error) {
            console.error("Error updating student:", error);
            alert("Failed to update student: " + error.message);
        }
    }

    function closeEditStudent() {
        document.getElementById('editStudentModal').classList.remove('show');
        currentEditingStudent = null;
    }

    // =============================
    // UTILITY FUNCTIONS
    // =============================
    function formatCourses(coursesData) {
        if (!coursesData) return 'No courses selected';
        
        try {
            let courses = [];
            
            if (Array.isArray(coursesData)) {
                courses = coursesData;
            } else if (typeof coursesData === 'string') {
                // Try to parse JSON string
                try {
                    const parsed = JSON.parse(coursesData);
                    courses = Array.isArray(parsed) ? parsed : [parsed];
                } catch {
                    // If it's a comma-separated string
                    if (coursesData.includes(',')) {
                        courses = coursesData.split(',').map(c => c.trim());
                    } else if (coursesData.trim() !== '') {
                        courses = [coursesData];
                    }
                }
            }
            
            courses = courses.filter(course => course && course.trim() !== '');
            
            return courses.length > 0 ? 
                courses.map(course => `<span class="course-tag">${course}</span>`).join('') : 
                'No courses selected';
                
        } catch (error) {
            console.error('Error parsing courses:', error);
            return 'Error loading courses';
        }
    }

    function generateProgressData(courses) {
        const coursesArray = Array.isArray(courses) ? courses : 
                        typeof courses === 'string' ? JSON.parse(courses) : [];
        
        return coursesArray.map(course => ({
            name: course,
            progress: Math.floor(Math.random() * 100) + 1
        }));
    }

    function showMessage(element, message, type) {
        if (!element) return;
        
        element.textContent = message;
        element.style.color = type === 'error' ? '#ef4444' : 
                            type === 'success' ? '#10b981' : '#6b7280';
    }

    function setButtonState(button, loading, text) {
        if (!button) return;
        
        button.disabled = loading;
        button.textContent = text;
    }

    function showTableError(message) {
        const tbody = document.querySelector("#studentsTable tbody");
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; color: #ef4444; padding: 20px;">${message}</td></tr>`;
    }

    // =============================
    // SEARCH & SORTING
    // =============================
    function searchStudents() {
        currentState.search = document.getElementById('searchInput').value.trim();
        currentState.page = 1;
        fetchStudents();
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        currentState.search = '';
        currentState.page = 1;
        fetchStudents();
    }

    function applySorting() {
        currentState.sort = document.getElementById('sortField').value;
        currentState.order = document.getElementById('sortOrder').value;
        currentState.page = 1;
        fetchStudents();
    }

    function sortByColumn(column) {
        if (currentState.sort === column) {
            currentState.order = currentState.order === 'ASC' ? 'DESC' : 'ASC';
        } else {
            currentState.sort = column;
            currentState.order = 'ASC';
        }
        
        document.getElementById('sortField').value = currentState.sort;
        document.getElementById('sortOrder').value = currentState.order;
        currentState.page = 1;
        fetchStudents();
    }

    // =============================
    // PAGINATION
    // =============================
    function updatePagination(response) {
        currentState.totalPages = response.totalPages || 1;
        currentState.totalStudents = response.total || 0;

        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');

        prevBtn.disabled = currentState.page <= 1;
        nextBtn.disabled = currentState.page >= currentState.totalPages;

        pageInfo.textContent = `Page ${currentState.page} of ${currentState.totalPages} (${currentState.totalStudents} students)`;
    }

    function nextPage() {
        if (currentState.page < currentState.totalPages) {
            currentState.page++;
            fetchStudents();
        }
    }

    function previousPage() {
        if (currentState.page > 1) {
            currentState.page--;
            fetchStudents();
        }
    }

    // =============================
    // EXPORT FUNCTIONS
    // =============================
    async function exportToCSV() {
        try {
            const res = await fetch(`${API_URL}/students/export/csv`);
            
            if (!res.ok) throw new Error('Failed to export CSV');
            
            const blob = await res.blob();
            downloadFile(blob, 'bucodel-students.csv');
        } catch (error) {
            console.error('Error exporting CSV:', error);
            alert('Failed to export CSV: ' + error.message);
        }
    }

    async function exportToPDF() {
        try {
            const res = await fetch(`${API_URL}/students/export/pdf`);
                
            if (!res.ok) throw new Error('Failed to export PDF');
            
            const blob = await res.blob();
            downloadFile(blob, 'bucodel-students.pdf');
        } catch (error) {
            console.error('Error exporting PDF:', error);
            alert('Failed to export PDF: ' + error.message);
        }
    }

    function downloadFile(blob, filename) {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    // =============================
    // STUDENT ACTIONS
    // =============================
    async function deleteStudent(id) {
        if (!confirm("Are you sure you want to delete this student?")) return;
        
        try {
            const res = await fetch(`${API_URL}/students/${id}`, { 
                method: "DELETE" 
            });
            
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.error || 'Failed to delete student');
            }
            
            alert("Student deleted successfully");
            currentState.page = 1;
            fetchStudents();
        } catch (error) {
            console.error("Error deleting student:", error);
            alert("Failed to delete student: " + error.message);
        }
    }
</script>
</body>
</html>